name: perf-pytest
on:
  workflow_dispatch:
    inputs:
      nic:
        description: NIC
        required: true
        type: choice
        options:
          - e810
          - e830
      sut_runner:
        description: SUT runner name
        required: true
        type: string
      second_host_runner:
        description: Second host runner name
        required: true
        type: string
      marker:
        description: Pytest marker filter (e.g. performance, base_performance)
        required: false
        type: string
  schedule:
    - cron: '0 22 * * *' # Every day at 10 PM UTC
permissions:
  contents: read
env:
  NIC: ${{ inputs.nic || vars.PERF_NIC }}
  SUT_RUNNER: ${{ inputs.sut_runner || vars.PERF_SUT_RUNNER }}
  MARKER: ${{ inputs.marker || 'base_performance' }}
jobs:
  build-sut:
    runs-on: "${{ inputs.sut_runner || vars.PERF_SUT_RUNNER }}"
    timeout-minutes: 60
    steps:
      - name: Harden-Runner
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          egress-policy: audit
      - name: Checkout MTL
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: "${{ github.ref }}"
      - uses: ./.github/actions/build

  build-second-host:
    runs-on: "${{ inputs.second_host_runner || vars.PERF_SECOND_HOST_RUNNER }}"
    timeout-minutes: 60
    steps:
      - name: Harden-Runner
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          egress-policy: audit
      - name: Checkout MTL
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: "${{ github.ref }}"
      - uses: ./.github/actions/build

  run-perf-tests:
    needs: [build-sut, build-second-host]
    runs-on: "${{ inputs.sut_runner || vars.PERF_SUT_RUNNER }}"
    timeout-minutes: 720
    steps:
      - name: Harden-Runner
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          egress-policy: audit
      - name: Set current date
        run: echo "CURRENT_DATE=$(date '+%y%m%d-%H%M%S')" >> "$GITHUB_ENV"
      - name: Checkout MTL
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: "${{ github.ref }}"
      - uses: ./.github/actions/build
      - name: Install pytest dependencies
        working-directory: ./tests/validation
        run: |
          python3 -m venv ./.venv
          source ./.venv/bin/activate
          pip install -r ./requirements.txt
      - name: Set session ID
        run: |
          runner_name="${{ runner.name }}"
          echo "SESSION_ID=${runner_name##*-}" >> "$GITHUB_ENV"
      - name: Set PCI device
        run: |
          if [ "${{ env.NIC }}" = "e810" ]; then
            echo "PCI_DEVICE=8086:1592,8086:1592" >> "$GITHUB_ENV"
          elif [ "${{ env.NIC }}" = "e830" ]; then
            echo "PCI_DEVICE=8086:12d2,8086:12d2" >> "$GITHUB_ENV"
          fi
      - name: Set CPU governor to performance
        run: |
          echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
          ssh -o StrictHostKeyChecking=no -i "${{ secrets.RUNNER_KEY_PATH }}" \
            "${{ secrets.RUNNER_USERNAME }}@${{ secrets.SECOND_HOST_IP }}" \
            'echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor'
      - name: Generate pytest configuration files
        working-directory: ./tests/validation/configs
        run: |
          python3 gen_config.py \
            --session_id "${{ env.SESSION_ID }}" \
            --mtl_path "${{ secrets.RUNNER_MTL_PATH }}" \
            --pci_device "${{ env.PCI_DEVICE }}" \
            --ip_address "${{ secrets.SUT_IP }}" \
            --username "${{ secrets.RUNNER_USERNAME }}" \
            --key_path ${{ secrets.RUNNER_KEY_PATH }} \
            --ebu_ip ${{ secrets.RUNNER_EBU_LIST_IP }} \
            --ebu_user ${{ secrets.RUNNER_EBU_LIST_USER }} \
            --ebu_password ${{ secrets.RUNNER_EBU_LIST_PASSWORD }} \
            --second_host_ip "${{ secrets.SECOND_HOST_IP }}" \
            --second_host_pci_device "${{ secrets.SECOND_HOST_PCI_DEVICE }}"
      - name: Export workflow tag for PCAP naming
        shell: bash
        run: |
          echo "MTL_GITHUB_WORKFLOW=${{ github.workflow }}:${{ env.NIC }}" >> "$GITHUB_ENV"
      - name: Start MtlManager
        run: |
          sudo MtlManager &
      - name: Run performance tests
        working-directory: ./tests/validation
        run: |
          ./.venv/bin/python3 -m pytest \
            --test_config=./configs/test_config.yaml \
            --topology_config=./configs/topology_config.yaml \
            -m "${{ env.MARKER }}" \
            --template=html/index.html \
            --report=./report.html \
            "./tests/dual/performance"
      - name: Generate performance report
        if: always()
        working-directory: ./tests/validation
        run: |
          ./.venv/bin/python3 common/generate_report.py \
            logs/performance -o performance_report.html
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: "perf-test-report-${{ env.SUT_RUNNER }}-${{ env.CURRENT_DATE }}"
          path: |
            ./tests/validation/report.html
            ./tests/validation/performance_report.html
