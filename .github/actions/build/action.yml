name: Build
runs:
  using: composite
  steps:
    - name: 'preparation: Checkout openh264'
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        repository: 'cisco/openh264'
        ref: 'openh264v2.4.0'
        path: 'openh264'
    - name: 'preparation: Checkout FFmpeg'
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        repository: 'FFmpeg/FFmpeg'
        ref: 'release/7.0'
        path: 'ffmpeg'
    - name: 'configuration: Install the build dependency'
      run: |
        sudo apt update
        sudo apt-get remove -y pipenv || true
        sudo apt-get install -y \
            git gcc meson tar zip \
            pkg-config \
            python3 \
            python3-pyelftools \
            python3-virtualenv \
            python3-pip \
            libnuma-dev \
            libjson-c-dev \
            libpcap-dev \
            libgtest-dev \
            libsdl2-dev \
            libsdl2-ttf-dev \
            libssl-dev \
            systemtap-sdt-dev \
            libbpf-dev \
            libelf1 \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-tools \
            gstreamer1.0-libav \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev
      shell: bash
    - name: 'installation: Build mtl'
      run: |
        ./build.sh
        sudo ldconfig
      shell: bash
    - name: 'installation: Build openh264'
      working-directory: openh264
      run: |
        make -j "$(nproc)"
        sudo make install
        sudo ldconfig
      shell: bash
    - name: 'installation: Build FFmpeg'
      working-directory: ffmpeg
      run: |
        git am ../ecosystem/ffmpeg_plugin/7.0/*.patch
        cp ../ecosystem/ffmpeg_plugin/mtl_*.c -rf libavdevice/
        cp ../ecosystem/ffmpeg_plugin/mtl_*.h -rf libavdevice/
        ./configure --enable-shared --disable-static --enable-nonfree --enable-pic --enable-gpl --enable-libopenh264 --enable-encoder=libopenh264 --enable-mtl
        make -j "$(nproc)"
        sudo make install
        sudo ldconfig
      shell: bash
    - name: 'installation: Build GStreamer'
      working-directory: ecosystem/gstreamer_plugin
      run: |
        ./build.sh
      shell: bash
